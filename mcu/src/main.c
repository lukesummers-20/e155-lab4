// Luke Summers lsummers@g.hmc.edu 9/28/2024
// main file for lab 4

#include <stdint.h>
#include "../lib/GPIO.h"
#include "../lib/RCC.h"
#include "../lib/TIM67.h"

// notes for fur elise
const int fur[][2] = {
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	250},
{  0,	125},
{494,	125},
{523,	125},
{587,	125},
{659,	375},
{392,	125},
{699,	125},
{659,	125},
{587,	375},
{349,	125},
{659,	125},
{587,	125},
{523,	375},
{330,	125},
{587,	125},
{523,	125},
{494,	250},
{  0,	125},
{330,	125},
{659,	125},
{  0,	250},
{659,	125},
{1319,	125},
{  0,	250},
{623,	125},
{659,	125},
{  0,	250},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	500},
{  0,	0}};

// notes for the melody of im blue
int blue[][2] = {
{466, 125},
{293, 125},
{392, 125},
{466, 125},
{523, 125},
{349, 125},
{440, 125},
{466, 250},
{392, 125},
{466, 125},
{587, 125},
{622, 125},
{392, 125},
{587, 125},
{523, 125},
{466, 125},
{293, 125},
{392, 125},
{466, 125},
{523, 125},
{349, 125},
{440, 125},
{466, 250},
{392, 125},
{466, 125},
{587, 125},
{622, 125},
{392, 125},
{587, 125},
{523, 125},
{466, 125},
{293, 125},
{392, 125},
{466, 125},
{523, 125},
{349, 125},
{440, 125},
{466, 250},
{392, 125},
{466, 125},
{587, 125},
{622, 125},
{392, 125},
{587, 125},
{523, 125},
{466, 125},
{293, 125},
{392, 125},
{466, 125},
{440, 125},
{261, 125},
{349, 125},
{392, 250},
{0, 125},
{349, 125},
{392, 250},
{349, 125},
{392,125},
{440, 125},
{466, 125},
{293, 125},
{392, 125},
{466, 125},
{523, 125},
{349, 125},
{440, 125},
{466, 250},
{392, 125},
{466, 125},
{587, 125},
{622, 125},
{392, 125},
{587, 125},
{523, 125},
{466, 125},
{293, 125},
{392, 125},
{466, 125},
{523, 125},
{349, 125},
{440, 125},
{466, 250},
{392, 125},
{466, 125},
{587, 125},
{622, 125},
{392, 125},
{587, 125},
{523, 125},
{466, 125},
{293, 125},
{392, 125},
{466, 125},
{523, 125},
{349, 125},
{440, 125},
{466, 250},
{392, 125},
{466, 125},
{587, 125},
{622, 125},
{392, 125},
{587, 125},
{523, 125},
{466, 125},
{293, 125},
{392, 125},
{466, 125},
{440, 125},
{261, 125},
{349, 125},
{392, 250},
{0, 125},
{349, 125},
{392, 250},
{349, 125},
{392,125},
{440, 125},
{0, 0}
};


int main(void) {
    //pins used
    int wavePin = 10;
    int switchPin1 = 4;
    int switchPin2 = 7;
    //enabling gpioa and tim6 and tim7
    enableGPIO(RCC, 0);
    enableBasicTimer(RCC, 6);
    enableBasicTimer(RCC, 7);

    //enabling pull up resistors on switch pins
    enablePullUp(switchPin1, GPIOA);
    enablePullUp(switchPin2, GPIOA);

    //setting pin modes
    pinMode(wavePin, GPIO_OUTPUT, GPIOA);
    pinMode(switchPin1, GPIO_INPUT, GPIOA);
    pinMode(switchPin2, GPIO_INPUT, GPIOA);

     //enabling timer counter
    enableCounter(TIM6);
    enableCounter(TIM7);

    //configuring ahb prescale, clk timers are 1 MHz
    RCC->CFGR |= (1 << 4);
    RCC->CFGR &= ~(1 << 5);
    RCC->CFGR &= ~(1 << 6);
    RCC->CFGR |= (1 << 7);

    //setting timer prescale so timer clk freq is 1 KHz
    setPrsc(TIM6, 0b1111100111);

    //setting timer prescale so timer clk freq is 1 MHz
    setPrsc(TIM7, 0);

    int len;

    while(1) {
      // read switch pins
      volatile int s1 = digitalRead(switchPin1, GPIOA);
      volatile int s2 = digitalRead(switchPin2, GPIOA);

      if (!s1) {
        //play fur elise
        len = sizeof(fur);
        for (int i = 0; i < len; i++) {
          genSqWave(fur[i][0], fur[i][1], wavePin, GPIOA, TIM6, TIM7);
        }
      }
      if (!s2) {
        //play im blue melody
        len = sizeof(blue);
        for (int i = 0; i < len; i++) {
          genSqWave(blue[i][0], blue[i][1], wavePin, GPIOA, TIM6, TIM7);
        }
      }
    }
    return 0;
}